{% extends 'base.html' %}
{% load static widget_tweaks custom_filters %}

{% block title %}Tablero de Órdenes{% endblock %}

{% block extra_head_css %}
    <style>
        /* --- Ocultar Sidebar y Ajustar Contenido SÓLO para esta página --- */
        #sidebar { display: none !important; }
        #mainContent { margin-left: 0 !important; }
        #sidebarToggle { display: none !important; }

        /* --- Estructura de Layout para Scroll Interno --- */
        body { overflow: hidden; }
        .content-wrapper { height: calc(100vh - 60px); display: flex; padding: 0; }
        #mainContent { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0; }
        .page-content { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; padding: 0; margin-top: 0; }
        .page-header { padding: 10px 15px; background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; }
        .page-title { font-size: 1.4rem; font-weight: 600; color: var(--accent-color); margin: 0; display: flex; align-items: center; }
        .page-title i { margin-right: 10px; }
        .tablero-container { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; }

        /* --- Estilos del Tablero --- */
        .seccion-dia { display: flex; flex-direction: column; margin-bottom: 1px; }
        .seccion-header { background-color: var(--accent-color); color: white; padding: 8px 15px; font-size: var(--header-font, 0.9rem); font-weight: 600; display: flex; align-items: center; position: sticky; top: 0; z-index: 100; }
        .seccion-header i { margin-right: 8px; }
        .seccion-tarjetas { padding: 8px; background-color: var(--bg-color); flex-grow: 1; min-height: 150px; }
        .ordenes-row { display: flex; flex-wrap: wrap; gap: 8px; }

        /* Estilos de cada tarjeta */
        .orden-card {
            background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; transition: transform 0.2s; cursor: grab; overflow: hidden;
            flex: 1 1 240px; /* Responsividad con Flex Basis */
        }

        /* --- Estilos internos de la tarjeta --- */
        .orden-card:hover { transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
        .orden-card:active { cursor: grabbing; }
        .orden-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; border-bottom: 1px solid var(--border-color); padding-bottom: 6px; }
        .orden-numero { font-weight: 600; color: var(--accent-color); font-size: var(--card-title-font, 0.85rem); }
        .orden-estado { background-color: rgba(108, 117, 125, 0.15); color: var(--secondary-color); font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 500; }
        .orden-info { display: flex; flex-wrap: wrap; margin-bottom: 8px; gap: 4px; }
        .info-item { display: flex; align-items: center; font-size: var(--card-text-font, 0.8rem); width: 100%; }
        .info-item i { width: 16px; margin-right: 6px; color: var(--secondary-color); font-size: 0.75rem; text-align: center; }
        .servicios-header { display: flex; align-items: center; font-size: var(--card-text-font, 0.8rem); font-weight: 600; margin-bottom: 6px; color: var(--secondary-color); border-top: 1px solid var(--border-color); padding-top: 6px; }
        .servicios-header i { margin-right: 6px; }
        .servicios-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }

        /* Estilo Servicio Item - MODIFICADO para wrapping */
        .servicio-item {
            padding: 4px 6px;
            border-radius: 4px;
            text-align: center; /* Centrar texto */
            /* Quitamos min-height para que se ajuste al contenido */
            font-size: var(--service-font, 0.75rem);
            font-weight: 500;
            color: white;
            word-break: break-word; /* Permite romper palabras largas si es necesario */
            /* white-space: normal; */ /* Valor por defecto, permite wrapping */
            /* Quitamos flex, overflow, text-overflow, white-space:nowrap */
        }
        .estado-terminado { background-color: var(--success-color); }
        .estado-no-realizado { background-color: var(--danger-color); }
        .estado-pendiente { background-color: var(--secondary-color); }
        .estado-proceso { background-color: var(--warning-color); }

        .no-orders { padding: 20px; text-align: center; color: var(--secondary-color); font-style: italic; }
        .ui-sortable-placeholder { border: 2px dashed var(--accent-color); background: rgba(0, 123, 255, 0.1); visibility: visible !important; min-height: 150px; border-radius: 6px; }

        /* --- Media Queries --- */
        @media (max-width: 576px) {
            /* Grid de servicios a 1 columna */
            .servicios-grid {
                grid-template-columns: 1fr;
                gap: 3px;
            }
            /* Ajustes menores de tamaño para móvil */
            .servicio-item {
                font-size: calc(var(--service-font, 0.75rem) * 0.9);
                padding: 3px 5px;
            }
            .orden-numero { font-size: calc(var(--card-title-font, 0.85rem) * 0.95); }
            .info-item { font-size: calc(var(--card-text-font, 0.8rem) * 0.95); }
            .orden-card { padding: 6px; }
            .seccion-tarjetas { padding: 6px; }
            .ordenes-row { gap: 6px; }
            .page-header { padding: 8px 10px;}
            .page-title { font-size: 1.2rem;}
        }
    </style>
{% endblock %}

{# No define navbar_right para usar el default (Switch + Lista) #}

{% block content %}
<div class="page-content">
    <div class="page-header">
      <h1 class="page-title"><i class="fas fa-th"></i> Tablero de Órdenes</h1>
    </div>
    <div class="tablero-container" id="tablero-container">
      {% include 'servicios/tablero_parcial.html' %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
    {# Scripts sin cambios #}
    <script>
        $(document).ready(function(){
          // --- Código JS para Sortable y WebSockets ---
          // (Asegúrate de que esté completo aquí, igual que en versiones anteriores)
          function initSortable() {
              $('.ordenes-row').sortable({ connectWith: ".ordenes-row", handle: ".orden-header", /* ... más opciones ... */ update: function(event, ui) { /* ... ajax ... */ } }).disableSelection();
          }
          initSortable();
          var ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
          var socket_servicios = new WebSocket(ws_scheme + '://' + window.location.host + '/ws/servicios/');
          var socket_ordenes = new WebSocket(ws_scheme + '://' + window.location.host + '/ws/ordenes/');
          socket_servicios.onmessage = function(e) { /* ... */ };
          socket_servicios.onclose = function(e) { console.error("Socket servicios cerrado"); };
          socket_ordenes.onmessage = function(e) { /* ... */ };
          socket_ordenes.onclose = function(e) { console.error("Socket órdenes cerrado"); };
          function actualizarTableroParcial() { /* ... */ }

          // --- Copia completa del JS anterior ---
          function initSortable() {
              $('.ordenes-row').sortable({
                  connectWith: ".ordenes-row", handle: ".orden-header", placeholder: "ui-sortable-placeholder", forcePlaceholderSize: true, tolerance: "pointer", revert: 300,
                  update: function(event, ui) { if (this === ui.item.parent()[0]) { var grupo = $(this).closest('.seccion-dia').find('.seccion-header').text().trim(); var nuevoOrden = []; $(this).children('.orden-card').each(function(index) { var orderId = $(this).data('order-id'); nuevoOrden.push({ id: orderId, newPos: (index + 1) * 10 }); }); console.log("Enviando actualización para grupo:", grupo, "Nuevo orden:", nuevoOrden); $.ajax({ url: "{% url 'actualizar_orden_manual' %}", method: "POST", data: JSON.stringify({ grupo: grupo, nuevo_orden: nuevoOrden }), contentType: "application/json", dataType: "json", headers: { "X-CSRFToken": "{{ csrf_token }}" }, success: function(response) { console.log("Orden actualizado", response); }, error: function(xhr, status, error) { console.error("Error al actualizar el orden:", error); $(ui.sender).sortable('cancel'); } }); } }
              }).disableSelection();
          }
          initSortable();
          socket_servicios.onmessage = function(e) { var data = JSON.parse(e.data); var elementos = document.querySelectorAll('[data-service-id="' + data.service_id + '"]'); elementos.forEach(function(elem) { elem.classList.remove('estado-pendiente', 'estado-proceso', 'estado-no-realizado', 'estado-terminado'); if (data.estado === "TERMINADO") elem.classList.add('estado-terminado'); else if (data.estado === "NO_REALIZADO") elem.classList.add('estado-no-realizado'); else if (data.estado === "PROCESO") elem.classList.add('estado-proceso'); else elem.classList.add('estado-pendiente'); }); };
          socket_ordenes.onmessage = function(e) { var data = JSON.parse(e.data); console.log("WS Órdenes:", data); if (data.type === "orden_terminada") { $("#order-card-" + data.order_id).fadeOut(300, function() { $(this).remove(); }); } else if (data.type === "orden_reorder" || data.tipo === "orden_reorder") { actualizarTableroParcial(); } else if (data.type === "servicio_agregado") { actualizarTableroParcial(); } else if (data.type === "orden_aceptada") { actualizarTableroParcial(); } else if (data.type === "orden_update") { var $card = $("#order-card-" + data.order_id); if($card.length > 0) { var $statusBadge = $card.find('.orden-estado'); if (data.nuevo_estado) $statusBadge.text(data.nuevo_estado); } } };
          function actualizarTableroParcial() { console.log("Solicitando tablero parcial..."); $.ajax({ url: "{% url 'tablero_parcial' %}?t=" + new Date().getTime(), method: "GET", success: function(response) { $("#tablero-container").html(response); initSortable(); console.log("Tablero parcial actualizado."); }, error: function(xhr, status, error) { console.error("Error al actualizar tablero parcial:", error); } }); }
        });
    </script>
{% endblock %}